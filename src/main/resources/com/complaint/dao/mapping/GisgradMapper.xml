<?xml version="1.0" encoding="UTF-8" ?>   
<!DOCTYPE mapper   
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"   
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.complaint.dao.GisgradMapper">

<!-- 公共过滤数据 -->
 <sql id="btable_where">
   (select flowid,sum(gg3 + gg2) sumc,
       decode(sum(gg3 + gg2),0,0, round(sum(g3cn) / sum(gg3 + gg2), 4)*100) free3,
       decode(sum(gg3 + gg2),0,0,round(sum(g2cn) / sum(gg3 + gg2), 4)*100) pocent2,
       decode(sum(gg3 + gg2),0,0,round(sum(n2 + n3) / sum(gg3 + gg2), 4)*100) talkaround
  from (select w.flowid,sum(case when w.rscp != -9999 then 1 else 0 end ) gg3,
               0 gg2,sum(case when w.rscp != -9998 and w.rscp != -9999 then 1 else
               0 end) g3cn, 0 g2cn, sum(case when w.rscp = -9998 and w.rscp != -9999 then
               1 else  0 end) n3, 0 n2
          from t_log_submanual_wcdma w,t_log_manual t where t.flowid=w.flowid 
    <if test="datatype!=null and datatype==1">
   <!--   and t.test_time >= to_date(#{startTime},'yyyy-mm-dd hh24:mi:ss')  and  to_date(#{endTime},'yyyy-mm-dd hh24:mi:ss') >=t.test_time -->
    </if>
     and w.test_time >= to_date(#{startTime},'yyyy-mm-dd hh24:mi:ss')  and  to_date(#{endTime},'yyyy-mm-dd hh24:mi:ss') >=w.test_time
    and t.net_type>=2 group by w.flowid
        union all select g.flowid, 0 gg3,
       sum(case when g.rxlev_Full != -9999 then 1 else 0 end) gg2,  0 g3cn,
       sum(case  when g.rxlev_Full != -9998 and g.rxlev_Full != -9999 then 1  else  0
       end) g2cn, 0 n3, sum(case when g.rxlev_Full = -9998 and g.rxlev_Full != -9999 then
        1 else 0 end) n2 from t_log_submanual_gsm g ,t_log_manual t where g.flowid=t.flowid 
         <!-- 开始结束时间 -->
    <if test="datatype!=null and datatype==1">
     <!-- and t.test_time >= to_date(#{startTime},'yyyy-mm-dd hh24:mi:ss')  and  to_date(#{endTime},'yyyy-mm-dd hh24:mi:ss') >=t.test_time -->
    </if>
    and g.test_time >= to_date(#{startTime},'yyyy-mm-dd hh24:mi:ss')  and  to_date(#{endTime},'yyyy-mm-dd hh24:mi:ss') >=g.test_time
    and t.net_type in (1,3)  group by g.flowid)
 group by flowid)b,t_test_workorder s,
    t_area_code  ar,t_scene_code  se 
    where  t.id=s.id
    and t.area_id=ar.areaid
    and t.sceneid=se.sceneid
    and b.flowid = t.flowid
        and lat_m>0 and lng_m>0 
  	<!-- 框选导出 -->
   	<if test = "minlatregion!=-1">
   	and lat_m &gt;= #{minlatregion} 
   	</if>
   	<if test = "minlatregion!=-1">
   	and lat_m &lt;= #{maxlatregion} 
   	</if>
   	<if test = "minlatregion!=-1">
   	and lng_m &gt;= #{minlngregion} 
   	</if>
   	<if test = "minlatregion!=-1">
   	and lng_m &lt;= #{maxlngregion} 
   	</if>
    <if test="datatype!=null and datatype==2">
    and s.first_time >= to_date(#{startTime},'yyyy-mm-dd hh24:mi:ss')  and  to_date(#{endTime},'yyyy-mm-dd hh24:mi:ss') >=s.first_time
    </if>
 </sql>
  <sql id="samesql_where_g">

    <!-- 区域 -->
    <if test="aatype!=null">
    and  t.area_id not in ('863450','863451','863452')
    </if>
    <if test="aatype!='-1'">
    and instr(','||#{areaids}||',',','||t.area_id||',')>0 
    </if>
    <!-- 业务类型 -->
    <if test="testtype!=null and bustype!=-1">
	    and(
	    <if test="tt!=null">
	      instr(','||#{tt}||',',','||t.test_type||',')>0 
	    </if>
	    <if test="tt!=null and yy!=null">
	    	or
	    </if>
	     <if test="yy!=null">
	        instr(','||#{yy}||',',','||t.call_type||',')>0 
	     </if>
	     <if test="tt!=null and ff!=null">
	    	or
	    </if>
	      <if test="ff!=null">
	        instr(','||#{ff}||',',','||t.ftp_type||',')>0 
	     </if>
	     )
    </if>

    <!-- 场景 -->
    <if test="senceids!=null and stype!=-1">
    and instr(','||#{senceids}||',',','||t.sceneid||',')>0 
    </if>
    <!-- 开始结束时间 -->
    <if test="datatype!=null and datatype==1">
     and g.test_time >= to_date(#{startTime},'yyyy-mm-dd hh24:mi:ss')  and  to_date(#{endTime},'yyyy-mm-dd hh24:mi:ss') >=g.test_time
    </if>
    
    <!-- 任务类型 -->
    <if test="jobtype!=null and jobtype!=-1">
     
    </if>
     <!-- 室内外 -->
    <if test="inside!=null and inside!=-1">
     and t.inside=#{inside}
    </if>
    <!-- 工单号,地址 -->
    <if test="sernos!=null and sernos!=''">
    and (t.serialno like '%' ||  #{sernos} || '%'  or t.test_adress like '%' ||  #{sernos} || '%')
    </if>
     <!-- 网络制式 
    <if test="nettype!=-1">
     <if test="nettype==1">
      and (t.net_type=2 or t.net_type=3)
     </if>
     <if test="nettype==2">
      and (t.net_type=1)
     </if>
    </if>-->
    <!-- 测试网络 -->
    <if test="testnet!='-1' and testnet!=null">
     and instr(','||#{testnet}||',',','||t.net_type||',')>0 
    </if>
    <!-- 上行-->
    <if test="kpi==4">
     and  t.ftp_type=1
    </if>
    <!-- 下行 -->
     <if test="kpi==5">
     and   t.test_type=3 and t.ftp_type=2
    </if>
    <!-- 计算占比 -->
    
    
  </sql>
  <sql id="samesql_where_w">

    <!-- 区域 -->
    <if test="aatype!=null">
    and  t.area_id not in ('863450','863451','863452')
    </if>
    <if test="aatype!='-1'">
    and instr(','||#{areaids}||',',','||t.area_id||',')>0 
    </if>
    <!-- 业务类型 -->
    <if test="testtype!=null and bustype!=-1">
	    and(
	    <if test="tt!=null">
	      instr(','||#{tt}||',',','||t.test_type||',')>0 
	    </if>
	    <if test="tt!=null and yy!=null">
	    	or
	    </if>
	     <if test="yy!=null">
	        instr(','||#{yy}||',',','||t.call_type||',')>0 
	     </if>
	     <if test="tt!=null and ff!=null">
	    	or
	    </if>
	      <if test="ff!=null">
	        instr(','||#{ff}||',',','||t.ftp_type||',')>0 
	     </if>
	     )
    </if>

    <!-- 场景 -->
    <if test="senceids!=null and stype!=-1">
    and instr(','||#{senceids}||',',','||t.sceneid||',')>0 
    </if>
    <!-- 开始结束时间 -->
    <if test="datatype!=null and datatype==1">
     and w.test_time >= to_date(#{startTime},'yyyy-mm-dd hh24:mi:ss')  and  to_date(#{endTime},'yyyy-mm-dd hh24:mi:ss') >=w.test_time
    </if>
    
    <!-- 任务类型 -->
    <if test="jobtype!=null and jobtype!=-1">
     
    </if>
     <!-- 室内外 -->
    <if test="inside!=null and inside!=-1">
     and t.inside=#{inside}
    </if>
    <!-- 工单号,地址 -->
    <if test="sernos!=null and sernos!=''">
    and (t.serialno like '%' ||  #{sernos} || '%'  or t.test_adress like '%' ||  #{sernos} || '%')
    </if>
     <!-- 网络制式 
    <if test="nettype!=-1">
     <if test="nettype==1">
      and (t.net_type=2 or t.net_type=3)
     </if>
     <if test="nettype==2">
      and (t.net_type=1)
     </if>
    </if>-->
    <!-- 测试网络 -->
    <if test="testnet!='-1' and testnet!=null">
     and instr(','||#{testnet}||',',','||t.net_type||',')>0 
    </if>
    <!-- 上行-->
    <if test="kpi==4">
     and  t.ftp_type=1
    </if>
    <!-- 下行 -->
     <if test="kpi==5">
     and   t.test_type=3 and t.ftp_type=2
    </if>
    <!-- 计算占比 -->
    
    
  </sql>
<!-- 字段语句 -->
<sql id="samesql_name">
t.serialno, net_type nettype,to_char(t.test_time, 'yyyy-mm-dd hh24:mi:ss') time,
       to_char(s.first_time, 'yyyy-mm-dd hh24:mi:ss') jtime,ar.areaname area,
       se.name sence,
       s.admissible_path path,
    <if test="isfirst!=null and isfirst==2">
       <if test="secendSerno!=null and secendSerno!=''">
       case when s.serialno like '%' ||  #{secendSerno} || '%'  then 2 
            when 1=1
            <foreach collection="arrss" item="item" index="index">
             and test_adress like '%' ||  #{item} || '%' 
            </foreach>
            then 2 
       else 0 end isf,
       </if>
    </if>
            t.flowid,
            free3,
           lat_m,lng_m,
           test_type,
           phone,
           lat_y,lng_y,
           net_worktype,
           talkaround,
           sumc,
           pocent2,
	       call_type,
	       ftp_type,
           test_adress problemsAddress
</sql>
<!-- 字段语句 -->
<sql id="samesql_tlog">
min(t.serialno) serialno,t.flowid,
          min(t.test_adress) test_adress,min(t.test_time)test_time,
           min(t.test_phone) phone,
           min(t.test_type)test_type,
           min(t.id)id,
	       min(t.call_type)call_type,
	       min(t.ftp_type)ftp_type,min(t.area_id)area_id, min(t.inside)inside,min(t.sceneid)sceneid,
</sql>
<!-- 分组语句 -->
<sql id="same_group">
 group by t.flowid
</sql>
<!-- 室内2G语句 -->
<sql id="indoor2">
    select <include refid="samesql_name"/> 
    <if test="iscenter==1">,
    '1' inside,
           case when rxlev_Sub=0 then null else round(rxlev_Sub_1/rxlev_Sub,4)*100 end rxlev_Sub_1,
           case when rxlev_Sub=0 then null else round(rxlev_Sub_3/rxlev_Sub,4)*100 end rxlev_Sub_3,
           case when rxlev_Sub=0 then null else round(rxlev_Sub_4/rxlev_Sub,4)*100 end rxlev_Sub_4,
          

           case when rxqual_Sub=0 then null else round(rxqual_Sub_1/rxqual_Sub,4)*100 end rxqual_Sub_1,
           case when rxqual_Sub=0 then null else round(rxqual_Sub_3/rxqual_Sub,4)*100 end rxqual_Sub_3,
           case when rxqual_Sub=0 then null else round(rxqual_Sub_4/rxqual_Sub,4)*100 end rxqual_Sub_4,
           
           case when ci_sub=0 then null else round(ci_1/ci_sub,4)*100 end ci_1,
           case when ci_sub=0 then null else round(ci_3/ci_sub,4)*100 end ci_3,
           case when ci_sub=0 then null else round(ci_4/ci_sub,4)*100 end ci_4    
     </if>     
    from 
    (
    select 
    <include refid="samesql_tlog"/>
          min(t.LATITUDE) lat_y,
          min(t.LONGITUDE) lng_y,
          min(case when (select s.configvalue from t_sysconfig s where s.configkey='t_map_type')='baidu' then t.longitude_bmap else t.longitude_modify end) lng_m,
          min(case when (select s.configvalue from t_sysconfig s where s.configkey='t_map_type')='baidu' then t.latitude_bmap else t.latitude_modify end) lat_m,
	       case when min(t.net_type)=1 then '1' when min(t.net_type)=3 then '4' else '0' end net_type,
          sum(case when g.rxlev_Full!=-9999 then 1 else 0 end) rxlev_Sub,
           <!-- rxlev_Sub -->
           sum(case when g.rxlev_Full!=-9999 and (g.rxlev_Full!=-9998 and 
           <if test="rxl_s_4_in==1">
             g.rxlev_Full>#{rxl_v_4_in} 
           </if>
           <if test="rxl_s_4_in==2">
             g.rxlev_Full>=#{rxl_v_4_in} 
           </if>
           <if test="rxl_s_4_in==3">
             #{rxl_v_4_in}>g.rxlev_Full
           </if>
           <if test="rxl_s_4_in==4">
           #{rxl_v_4_in}>=g.rxlev_Full
           </if>
           ) then 1 else 0 end) rxlev_Sub_1,
           
           sum(case when g.rxlev_Full!=-9999 and g.rxlev_Full!=-9998 and 
           <if test="rxl_s_2_in==1">
             g.rxlev_Full>#{rxl_v_2_in} 
           </if>
           <if test="rxl_s_2_in==2">
             g.rxlev_Full>=#{rxl_v_2_in} 
           </if>
           <if test="rxl_s_2_in==3">
             #{rxl_v_2_in}>g.rxlev_Full
           </if>
           <if test="rxl_s_2_in==4">
           #{rxl_v_2_in}>=g.rxlev_Full
           </if>
           
            then 1 else 0 end) rxlev_Sub_3,
           sum(case when g.rxlev_Full!=-9999 and g.rxlev_Full!=-9998 and 
         <if test="rxl_s_1_in==1">
             g.rxlev_Full>#{rxl_v_1_in} 
           </if>
           <if test="rxl_s_1_in==2">
             g.rxlev_Full>=#{rxl_v_1_in} 
           </if>
           <if test="rxl_s_1_in==3">
             #{rxl_v_1_in}>g.rxlev_Full
           </if>
           <if test="rxl_s_1_in==4">
           #{rxl_v_1_in}>=g.rxlev_Full
           </if>
            then 1 else 0 end) rxlev_Sub_4,
           <!-- rxqual_Sub -->
           sum(case when g.rxqual_Sub!=-9999 then 1 else 0 end) rxqual_Sub,
           
           sum(case when g.rxqual_Sub!=-9999 and g.rxqual_sub!=-9998 and 
         <if test="rxq_s_1_in==1">
             g.rxqual_Sub>#{rxq_v_1_in} 
           </if>
           <if test="rxq_s_1_in==2">
             g.rxqual_Sub>=#{rxq_v_1_in} 
           </if>
           <if test="rxq_s_1_in==3">
             #{rxq_v_1_in}>g.rxqual_Sub
           </if>
           <if test="rxq_s_1_in==4">
           #{rxq_v_1_in}>=g.rxqual_Sub
           </if>

          then 1 else 0 end) rxqual_Sub_4,
           sum(case when g.rxqual_Sub!=-9999 and rxqual_Sub!=-9998 and 
            <if test="rxq_s_2_in==1">
             g.rxqual_Sub>#{rxq_v_2_in} 
           </if>
           <if test="rxq_s_2_in==2">
             g.rxqual_Sub>=#{rxq_v_2_in} 
           </if>
           <if test="rxq_s_2_in==3">
             #{rxq_v_2_in}>g.rxqual_Sub
           </if>
           <if test="rxq_s_2_in==4">
           #{rxq_v_2_in}>=g.rxqual_Sub
           </if>
           then 1 else 0 end) rxqual_Sub_3,
           sum(case when g.rxqual_Sub!=-9999 and g.rxqual_Sub!=-9998 and 
           
              <if test="rxq_s_4_in==1">
             g.rxqual_Sub>#{rxq_v_4_in} 
           </if>
           <if test="rxq_s_4_in==2">
             g.rxqual_Sub>=#{rxq_v_4_in} 
           </if>
           <if test="rxq_s_4_in==3">
             #{rxq_v_4_in}>g.rxqual_Sub
           </if>
           <if test="rxq_s_4_in==4">
           #{rxq_v_4_in}>=g.rxqual_Sub
           </if>
           then 1 else 0 end) rxqual_Sub_1,
           <!-- C/I -->
           sum(case when g.c_i!=-9999 then 1 else 0 end) ci_Sub,
           sum(case when g.c_i!=-9999 and (g.c_i!=-9998 and 
           <if test="ci_s_4_in==1">
             g.c_i>#{ci_v_4_in} 
           </if>
           <if test="ci_s_4_in==2">
             g.c_i>=#{ci_v_4_in} 
           </if>
           <if test="ci_s_4_in==3">
             #{ci_v_4_in}>g.c_i
           </if>
           <if test="ci_s_4_in==4">
           #{ci_v_4_in}>=g.c_i
           </if>
           ) then 1 else 0 end) ci_1,
           
           sum(case when g.c_i!=-9999 and g.c_i!=-9998 and 
           <if test="ci_s_2_in==1">
             g.c_i>#{ci_v_2_in} 
           </if>
           <if test="ci_s_2_in==2">
             g.c_i>=#{ci_v_2_in} 
           </if>
           <if test="ci_s_2_in==3">
             #{ci_v_2_in}>g.c_i
           </if>
           <if test="rxl_s_2_in==4">
           #{ci_v_2_in}>=g.c_i
           </if>
           
            then 1 else 0 end) ci_3,
           sum(case when g.c_i!=-9999 and g.c_i!=-9998 and 
         <if test="ci_s_1_in==1">
             g.c_i>#{ci_v_1_in} 
           </if>
           <if test="ci_s_1_in==2">
             g.c_i>=#{ci_v_1_in} 
           </if>
           <if test="ci_s_1_in==3">
             #{ci_v_1_in}>g.c_i
           </if>
           <if test="ci_s_1_in==4">
           #{ci_v_1_in}>=g.c_i
           </if>
            then 1 else 0 end) ci_4
      
    from t_log_submanual_gsm g,
    t_log_manual t where g.flowid=t.flowid
    <include refid="samesql_where_g" />
    <!-- and g.ep_time >= to_date(#{startTime},'yyyy-mm-dd hh24:mi:ss')-1  and  to_date(#{endTime},'yyyy-mm-dd hh24:mi:ss')+1 >=g.ep_time -->
    <!-- 路测指标查询，排除查询指标为-9999的点 --> 
    <if test="kpi==6">
    and g.rxlev_Full&lt;>-9999
    </if>
    <if test="kpi==7">
    and g.rxqual_Sub&lt;>-9999
    </if>
    <if test="kpi==8">
    and g.c_i&lt;>-9999
    </if>
    <!-- 指标查询 -->
    <if test="kpi!=-1 and kpi!=6 and kpi!=7 and kpi!=8">
     and t.net_type=2
    </if>
    <!-- 非3G -->
     <if test="nettype==1">
     and t.net_type=2
    </if>
     and t.net_type in(1,3)
    <!-- 规避2G锁频有3G数据 -->
    and g.inside=1  
    <include refid="same_group"/>
    ) t, <include refid="btable_where"/>
</sql>
<!-- 室内 3G语句-->
<sql id="indoor3">
select <include refid="samesql_name"/>

 <if test="iscenter==1">,
 '1' inside,
       test_adress problemsAddress,
   ftp_avg_speed,
           case when rscp=0 then null else round(rscp_1/rscp,4)*100 end rscp_1,
           case when rscp=0 then null else round(rscp_3/rscp,4)*100 end rscp_3,
           case when rscp=0 then null else round(rscp_4/rscp,4)*100 end rscp_4,
           case when ec_no=0 then null else round(ec_no_1/ec_no,4)*100 end ec_no_1,
           case when ec_no=0 then null else round(ec_no_3/ec_no,4)*100 end ec_no_3,
           case when ec_no=0 then null else round(ec_no_4/ec_no,4)*100 end ec_no_4,    
           case when txpower=0 then null else round(txpower_1/txpower,4)*100 end txpower_1,
           case when txpower=0 then null else round(txpower_3/txpower,4)*100 end txpower_3,
           case when txpower=0 then null else round(txpower_4/txpower,4)*100 end txpower_4,
           case when ftp_speed_up=0 then null else round(ftp_speed_up_1/ftp_speed_up,4)*100 end ftp_speed_up_1,
           case when ftp_speed_up=0 then null else round(ftp_speed_up_3/ftp_speed_up,4)*100 end ftp_speed_up_3,
           case when ftp_speed_up=0 then null else round(ftp_speed_up_4/ftp_speed_up,4)*100 end ftp_speed_up_4,
           case when ftp_speed_down=0 then null else round(ftp_speed_down_1/ftp_speed_down,4)*100 end ftp_speed_down_1,
           case when ftp_speed_down=0 then null else round(ftp_speed_down_3/ftp_speed_down,4)*100 end ftp_speed_down_3,
           case when ftp_speed_down=0 then null else round(ftp_speed_down_4/ftp_speed_down,4)*100 end ftp_speed_down_4
   </if>    
    from 
    (
    select <include refid="samesql_tlog"/>
          min(t.LATITUDE) lat_y,
          min(t.LONGITUDE) lng_y,
          min(case when (select s.configvalue from t_sysconfig s where s.configkey='t_map_type')='baidu' then t.longitude_bmap else t.longitude_modify end) lng_m,
          min(case when (select s.configvalue from t_sysconfig s where s.configkey='t_map_type')='baidu' then t.latitude_bmap else t.latitude_modify end) lat_m,
           min(t.ftp_avg_speed)ftp_avg_speed,
      case when min(t.net_type)=2 then '2' when min(t.net_type)=3 then '3' else '0' end net_type,
           <!--rscp  -->
           sum(case when w.rscp!=-9999 then 1 else 0 end) rscp,
           sum(case when w.rscp!=-9999 and (w.rscp! =-9998 and 
            <if test="rscp_s_4_in==1">
             w.rscp>#{rscp_v_4_in} 
           </if>
           <if test="rscp_s_4_in==2">
             w.rscp>=#{rscp_v_4_in} 
           </if>
           <if test="rscp_s_4_in==3">
             #{rscp_v_4_in}>w.rscp
           </if>
           <if test="rscp_s_4_in==4">
           #{rscp_v_4_in}>=w.rscp
           </if>

           ) then 1 else 0 end) rscp_1,
           
           sum(case when rscp!=-9999 and  w.rscp! =-9998 and 
             <if test="rscp_s_2_in==1">
             rscp>#{rscp_v_2_in} 
           </if>
           <if test="rscp_s_2_in==2">
             rscp>=#{rscp_v_2_in} 
           </if>
           <if test="rscp_s_2_in==3">
             #{rscp_v_2_in}>rscp
           </if>
           <if test="rscp_s_2_in==4">
           #{rscp_v_2_in}>=rscp
           </if>
    
           then 1 else 0 end) rscp_3,
           sum(case when w.rscp!=-9999 and  w.rscp! =-9998 and 
              <if test="rscp_s_1_in==1">
             w.rscp>#{rscp_v_1_in} 
           </if>
           <if test="rscp_s_1_in==2">
             w.rscp>=#{rscp_v_1_in} 
           </if>
           <if test="rscp_s_1_in==3">
             #{rscp_v_1_in}>w.rscp
           </if>
           <if test="rscp_s_1_in==4">
           #{rscp_v_1_in}>=w.rscp
           </if>
   
           then 1 else 0 end) rscp_4,
           
           <!-- ec_no -->
           sum(case when ec_no!=-9999 then 1 else 0 end) ec_no,
           sum(case when w.ec_no!=-9999 and (w.ec_no!=-9998 and 
           
             <if test="ecno_s_4_in==1">
             w.ec_no>#{ecno_v_4_in} 
           </if>
           <if test="ecno_s_4_in==2">
             w.ec_no>=#{ecno_v_4_in} 
           </if>
           <if test="ecno_s_4_in==3">
             #{ecno_v_4_in}>w.ec_no
           </if>
           <if test="ecno_s_4_in==4">
           #{ecno_v_4_in}>=w.ec_no
           </if>
           
           ) then 1 else 0 end) ec_no_1,
         
           sum(case when w.ec_no!=-9999 and w.ec_no!=-9998 and 
           <if test="ecno_s_2==1">
             w.ec_no>#{ecno_v_2} 
           </if>
           <if test="ecno_s_2==2">
             w.ec_no>=#{ecno_v_2} 
           </if>
           <if test="ecno_s_2==3">
             #{ecno_v_2}>w.ec_no
           </if>
           <if test="ecno_s_2==4">
           #{ecno_v_2}>=w.ec_no
           </if>
           
    
           then 1 else 0 end) ec_no_3,
           sum(case when w.ec_no!=-9999 and w.ec_no!=-9998 and 
           <if test="ecno_s_1_in==1">
             w.ec_no>#{ecno_v_1_in} 
           </if>
           <if test="ecno_s_1_in==2">
             w.ec_no>=#{ecno_v_1_in} 
           </if>
           <if test="ecno_s_1_in==3">
             #{ecno_v_1_in}>w.ec_no
           </if>
           <if test="ecno_s_1_in==4">
           #{ecno_v_1_in}>=w.ec_no
           </if>
       
           then 1 else 0 end) ec_no_4,
           
           <!-- txpower -->
           sum(case when w.txpower!=-9999 then 1 else 0 end) txpower,
           
           sum(case when w.txpower!=-9999 and w.txpower!=-9998 and 
           <if test="tx_s_1_in==1">
             w.txpower>#{tx_v_1_in} 
           </if>
           <if test="tx_s_1_in==2">
             w.txpower>=#{tx_v_1_in} 
           </if>
           <if test="tx_s_1_in==3">
             #{tx_v_1_in}>w.txpower
           </if>
           <if test="tx_s_1_in==4">
           #{tx_v_1_in}>=w.txpower
           </if>
           
            then 1 else 0 end) txpower_4,
           sum(case when w.txpower!=-9999 and w.txpower!=-9998 and
            <if test="tx_s_2_in==1">
             w.txpower>#{tx_v_2_in} 
           </if>
           <if test="tx_s_2_in==2">
             w.txpower>=#{tx_v_2_in} 
           </if>
           <if test="tx_s_2_in==3">
             #{tx_v_2_in}>w.txpower
           </if>
           <if test="tx_s_2_in==4">
           #{tx_v_2_in}>=w.txpower
           </if>
           
            then 1 else 0 end) txpower_3,
          
           sum(case when w.txpower!=-9999 and w.txpower!=-9998 and 
         <if test="tx_s_4_in==1">
             w.txpower>#{tx_v_4_in} 
           </if>
           <if test="tx_s_4_in==2">
             w.txpower>=#{tx_v_4_in} 
           </if>
           <if test="tx_s_4_in==3">
             #{tx_v_4_in}>w.txpower
           </if>
           <if test="tx_s_4_in==4">
           #{tx_v_4_in}>=w.txpower
           </if>
           then 1 else 0 end) txpower_1,
          
           <!-- FTP上行 -->
           sum(case when w.ftp_type=1 and w.ftp_speed!=-9999 then 1 else 0 end) ftp_speed_up,
           
           sum(case when w.ftp_type=1 and w.ftp_speed!=-9999 and (w.ftp_speed!=-9998 and (
            <if test="fu_s_1_in==1">
             w.ftp_speed>#{fu_v_1_in} 
           </if>
           <if test="fu_s_1_in==2">
             w.ftp_speed>=#{fu_v_1_in} 
           </if>
           <if test="fu_s_1_in==3">
             #{fu_v_1_in}>w.ftp_speed
           </if>
           <if test="fu_s_1_in==4">
           #{fu_v_1_in}>=w.ftp_speed
           </if>
           
       
           
           )
           
           ) then 1 else 0 end) ftp_speed_up_4,
           sum(case when w.ftp_type=1 and w.ftp_speed!=-9999 and w.ftp_speed!=-9998 and
              <if test="fu_s_2_in==1">
             w.ftp_speed>#{fu_v_2_in} 
           </if>
           <if test="fu_s_2_in==2">
             w.ftp_speed>=#{fu_v_2_in} 
           </if>
           <if test="fu_s_2_in==3">
             #{fu_v_2_in}>w.ftp_speed
           </if>
           <if test="fu_s_2_in==4">
           #{fu_v_2_in}>=w.ftp_speed
           </if>
           
           
           
           
           then 1 else 0 end) ftp_speed_up_3,
          
           sum(case when w.ftp_type=1 and w.ftp_speed!=-9999 and  w.ftp_speed!=-9998 and
           
            <if test="fu_s_4_in==1">
             w.ftp_speed>#{fu_v_2_in} 
           </if>
           <if test="fu_s_4_in==2">
             w.ftp_speed>=#{fu_v_4_in} 
           </if>
           <if test="fu_s_4_in==3">
             #{fu_v_4_in}>w.ftp_speed
           </if>
           <if test="fu_s_4_in==4">
           #{fu_v_4_in}>=w.ftp_speed
           </if>
           
        
           
           then 1 else 0 end) ftp_speed_up_1,
           <!-- FTP下行 -->
           sum(case when w.ftp_type=2 and w.ftp_speed!=-9999 then 1 else 0 end) ftp_speed_down,
           sum(case when w.ftp_type=2 and w.ftp_speed!=-9999 and (w.ftp_speed!=-9998 and  
           (
            <if test="fd_s_1_in==1">
             w.ftp_speed>#{fd_v_1_in} 
           </if>
           <if test="fd_s_1_in==2">
             w.ftp_speed>=#{fd_v_1_in} 
           </if>
           <if test="fd_s_1_in==3">
             #{fd_v_1_in}>w.ftp_speed
           </if>
           <if test="fd_s_1_in==4">
           #{fd_v_1_in}>=w.ftp_speed
           </if>
           
          
           
           )
           )  then 1 else 0 end) ftp_speed_down_4,
           sum(case when w.ftp_type=2 and w.ftp_speed!=-9999 and w.ftp_speed!=-9998 and
            <if test="fd_s_2==1">
             w.ftp_speed>#{fd_v_2} 
           </if>
           <if test="fd_s_2==2">
             w.ftp_speed>=#{fd_v_2} 
           </if>
           <if test="fd_s_2==3">
             #{fd_v_2}>w.ftp_speed
           </if>
           <if test="fd_s_2==4">
           #{fd_v_2}>=w.ftp_speed
           </if>
           
          
           
           
           then 1 else 0 end ) ftp_speed_down_3,
        
           sum(case when w.ftp_type=2 and w.ftp_speed!=-9999 and w.ftp_speed!=-9998 and
              <if test="fd_s_4_in==1">
             w.ftp_speed>#{fd_v_4_in} 
           </if>
           <if test="fd_s_4_in==2">
             w.ftp_speed>=#{fd_v_4_in} 
           </if>
           <if test="fd_s_4_in==3">
             #{fd_v_4_in}>w.ftp_speed
           </if>
           <if test="fd_s_4_in==4">
           #{fd_v_4_in}>=w.ftp_speed
           </if>
           
           
           then 1 else 0 end ) ftp_speed_down_1
           
      from t_log_submanual_wcdma w ,t_log_manual t where w.flowid=t.flowid

    <include refid="samesql_where_w" />  
    <!-- and w.ep_time >= to_date(#{startTime},'yyyy-mm-dd hh24:mi:ss')-1  and  to_date(#{endTime},'yyyy-mm-dd hh24:mi:ss')+1 >=w.ep_time -->
    <!-- 路测指标查询，排除查询指标为-9999的点 --> 
    <if test="kpi==1">
    and w.rscp&lt;>-9999
    </if>
    <if test="kpi==2">
    and w.ec_no&lt;>-9999
    </if>
    <if test="kpi==3">
    and w.txpower&lt;>-9999
    </if>
    <if test="kpi==4">
    and w.ftp_type=1
    and w.ftp_speed&lt;>-9999
    </if>
   	<if test="kpi==5">
    and w.ftp_type=2
    and w.ftp_speed&lt;>-9999
    </if>
     <!-- 指标查询 -->
    <if test="kpi==6 or kpi==7 or kpi==8">
      and t.net_type=1
    </if>
    <!-- GSM时可选择自由模式 -->
    <if test="nettype==2">
     and t.net_type=1
    </if>
    and t.net_type in(2,3)
     and w.inside=1
     <!-- 规避3G锁频有2G数据 -->
    
    <include refid="same_group"/>
	
    ) t,<include refid="btable_where"/> 
</sql>
<!-- 室外2G语句 -->
<sql id="outdoor2">
    select 
    <include refid="samesql_name"/>
     <if test="iscenter==1">,
     '0' inside,
           case when rxlev_Sub=0 then null else round(rxlev_Sub_1/rxlev_Sub,4)*100 end rxlev_Sub_1,
           case when rxlev_Sub=0 then null else round(rxlev_Sub_3/rxlev_Sub,4)*100 end rxlev_Sub_3,
           case when rxlev_Sub=0 then null else round(rxlev_Sub_4/rxlev_Sub,4)*100 end rxlev_Sub_4,
          

           case when rxqual_Sub=0 then null else round(rxqual_Sub_1/rxqual_Sub,4)*100 end rxqual_Sub_1,
           case when rxqual_Sub=0 then null else round(rxqual_Sub_3/rxqual_Sub,4)*100 end rxqual_Sub_3,
           case when rxqual_Sub=0 then null else round(rxqual_Sub_4/rxqual_Sub,4)*100 end rxqual_Sub_4,
           
           
           case when ci_sub=0 then null else round(ci_1/ci_sub,4)*100 end ci_1,
           case when ci_sub=0 then null else round(ci_3/ci_sub,4)*100 end ci_3,
           case when ci_sub=0 then null else round(ci_4/ci_sub,4)*100 end ci_4
           
           
      </if>       
    from 
    (
    select <include refid="samesql_tlog"/>
	      case when min(t.net_type)=1 then '1' when min(t.net_type)=3 then '4' else '0' end net_type,
	      avg(case when g.longitude_modify>0 then (case when (select s.configvalue from t_sysconfig s where s.configkey='t_map_type')='baidu' then g.longitude_bmap else g.longitude_modify end) else 0 end) lng_m,
          avg(case when g.latitude_modify>0 then (case when (select s.configvalue from t_sysconfig s where s.configkey='t_map_type')='baidu' then g.latitude_bmap else g.latitude_modify end) else 0 end) lat_m,
          avg(case when g.LATITUDE>0 then g.LATITUDE else 0 end) lat_y,
          avg(case when g.LONGITUDE>0 then g.LONGITUDE else 0 end) lng_y,
          sum(case when g.rxlev_Full!=-9999 then 1 else 0 end) rxlev_Sub,
           <!-- rxlev_Sub -->
           sum(case when g.rxlev_Full!=-9999 and (g.rxlev_Full!=-9998 and 
           <if test="rxl_s_4==1">
             g.rxlev_Full>#{rxl_v_4} 
           </if>
           <if test="rxl_s_4==2">
             g.rxlev_Full>=#{rxl_v_4} 
           </if>
           <if test="rxl_s_4==3">
             #{rxl_v_4}>g.rxlev_Full
           </if>
           <if test="rxl_s_4==4">
           #{rxl_v_4}>=g.rxlev_Full
           </if>
           ) then 1 else 0 end) rxlev_Sub_1,
           
           sum(case when g.rxlev_Full!=-9999 and g.rxlev_Full!=-9998 and 
           <if test="rxl_s_2==1">
             g.rxlev_Full>#{rxl_v_2} 
           </if>
           <if test="rxl_s_2==2">
             g.rxlev_Full>=#{rxl_v_2} 
           </if>
           <if test="rxl_s_2==3">
             #{rxl_v_2}>g.rxlev_Full
           </if>
           <if test="rxl_s_2==4">
           #{rxl_v_2}>=g.rxlev_Full
           </if>
           
            then 1 else 0 end) rxlev_Sub_3,
           sum(case when g.rxlev_Full!=-9999 and g.rxlev_Full!=-9998 and 
         <if test="rxl_s_1==1">
             g.rxlev_Full>#{rxl_v_1} 
           </if>
           <if test="rxl_s_1==2">
             g.rxlev_Full>=#{rxl_v_1} 
           </if>
           <if test="rxl_s_1==3">
             #{rxl_v_1}>g.rxlev_Full
           </if>
           <if test="rxl_s_1==4">
           #{rxl_v_1}>=g.rxlev_Full
           </if>
            then 1 else 0 end) rxlev_Sub_4,
           <!-- rxqual_Sub -->
           sum(case when g.rxqual_Sub!=-9999 then 1 else 0 end) rxqual_Sub,
           
           sum(case when g.rxqual_Sub!=-9999 and g.rxqual_Sub!=-9998 and 
         <if test="rxq_s_1==1">
             g.rxqual_Sub>#{rxq_v_1} 
           </if>
           <if test="rxq_s_1==2">
             g.rxqual_Sub>=#{rxq_v_1} 
           </if>
           <if test="rxq_s_1==3">
             #{rxq_v_1}>g.rxqual_Sub
           </if>
           <if test="rxq_s_1==4">
           #{rxq_v_1}>=g.rxqual_Sub
           </if>

          then 1 else 0 end) rxqual_Sub_4,
           sum(case when g.rxqual_Sub!=-9999 and rxqual_Sub!=-9998 and 
            <if test="rxq_s_2==1">
             g.rxqual_Sub>#{rxq_v_2} 
           </if>
           <if test="rxq_s_2==2">
             g.rxqual_Sub>=#{rxq_v_2} 
           </if>
           <if test="rxq_s_2==3">
             #{rxq_v_2}>g.rxqual_Sub
           </if>
           <if test="rxq_s_2==4">
           #{rxq_v_2}>=g.rxqual_Sub
           </if>
           then 1 else 0 end) rxqual_Sub_3,
           sum(case when g.rxqual_Sub!=-9999 and g.rxqual_Sub!=-9998 and 
           
              <if test="rxq_s_4==1">
             g.rxqual_Sub>#{rxq_v_4} 
           </if>
           <if test="rxq_s_4==2">
             g.rxqual_Sub>=#{rxq_v_4} 
           </if>
           <if test="rxq_s_4==3">
             #{rxq_v_4}>g.rxqual_Sub
           </if>
           <if test="rxq_s_4==4">
           #{rxq_v_4}>=g.rxqual_Sub
           </if>
           then 1 else 0 end) rxqual_Sub_1,
      
      		 <!-- C/I -->
           sum(case when g.c_i!=-9999 then 1 else 0 end) ci_sub,
           
           sum(case when g.c_i!=-9999 and g.c_i!=-9998 and 
         <if test="ci_s_1==1">
             g.c_i>#{ci_v_1} 
           </if>
           <if test="ci_s_1==2">
             g.c_i>=#{ci_v_1} 
           </if>
           <if test="ci_s_1==3">
             #{ci_v_1}>g.c_i
           </if>
           <if test="ci_s_1==4">
           #{ci_v_1}>=g.c_i
           </if>

          then 1 else 0 end) ci_4,
           sum(case when g.c_i!=-9999 and g.c_i!=-9998 and 
            <if test="ci_s_2==1">
             g.c_i>#{ci_v_2} 
           </if>
           <if test="ci_s_2==2">
             g.c_i>=#{ci_v_2} 
           </if>
           <if test="ci_s_2==3">
             #{ci_v_2}>g.c_i
           </if>
           <if test="ci_s_2==4">
           #{ci_v_2}>=g.c_i
           </if>
           then 1 else 0 end) ci_3,
           sum(case when g.c_i!=-9999 and g.c_i!=-9998 and 
           
              <if test="ci_s_4==1">
             g.c_i>#{ci_v_4} 
           </if>
           <if test="ci_s_4==2">
             g.c_i>=#{ci_v_4} 
           </if>
           <if test="ci_s_4==3">
             #{ci_v_4}>g.c_i
           </if>
           <if test="ci_s_4==4">
           #{ci_v_4}>=g.c_i
           </if>
           then 1 else 0 end) ci_1
           
    from t_log_submanual_gsm g,t_log_manual t 
     where g.flowid=t.flowid 
    <include refid="samesql_where_g"/>
    <!-- and g.ep_time >= to_date(#{startTime},'yyyy-mm-dd hh24:mi:ss')-1  and  to_date(#{endTime},'yyyy-mm-dd hh24:mi:ss')+1 >=g.ep_time -->
	<!-- 路测指标查询，排除查询指标为-9999的点 --> 
    <if test="kpi==6">
    and g.rxlev_Full&lt;>-9999
    </if>
    <if test="kpi==7">
    and g.rxqual_Sub&lt;>-9999
    </if>
    <if test="kpi==8">
    and g.c_i&lt;>-9999
    </if>
    <!-- 指标查询 -->
    <if test="kpi!=-1 and kpi!=6 and kpi!=7 and kpi!=8">
     and t.net_type=2
    </if>
    <!-- 非3G -->
     <if test="nettype==1">
     and t.net_type=2
    </if>
     and t.net_type in(1,3)
    <!-- 规避3G锁频有2G数据 -->
      and g.inside=0
   <include refid="same_group"/>
    ) t,<include refid="btable_where"/> 
</sql>
<!-- 室外 3G语句-->
<sql id="outdoor3">
 select <include refid="samesql_name"/>
 
 <if test="iscenter==1">,
 '0' inside,
   ftp_avg_speed,
           case when rscp=0 then null else round(rscp_1/rscp,4)*100 end rscp_1,
           case when rscp=0 then null else round(rscp_3/rscp,4)*100 end rscp_3,
           case when rscp=0 then null else round(rscp_4/rscp,4)*100 end rscp_4,
           case when ec_no=0 then null else round(ec_no_1/ec_no,4)*100 end ec_no_1,
           case when ec_no=0 then null else round(ec_no_3/ec_no,4)*100 end ec_no_3,
           case when ec_no=0 then null else round(ec_no_4/ec_no,4)*100 end ec_no_4,      
           case when txpower=0 then null else round(txpower_1/txpower,4)*100 end txpower_1,
           case when txpower=0 then null else round(txpower_3/txpower,4)*100 end txpower_3,
           case when txpower=0 then null else round(txpower_4/txpower,4)*100 end txpower_4,
           case when ftp_speed_up=0 then null else round(ftp_speed_up_1/ftp_speed_up,4)*100 end ftp_speed_up_1,
           case when ftp_speed_up=0 then null else round(ftp_speed_up_3/ftp_speed_up,4)*100 end ftp_speed_up_3,
           case when ftp_speed_up=0 then null else round(ftp_speed_up_4/ftp_speed_up,4)*100 end ftp_speed_up_4,
           case when ftp_speed_down=0 then null else round(ftp_speed_down_1/ftp_speed_down,4)*100 end ftp_speed_down_1,
           case when ftp_speed_down=0 then null else round(ftp_speed_down_3/ftp_speed_down,4)*100 end ftp_speed_down_3,
           case when ftp_speed_down=0 then null else round(ftp_speed_down_4/ftp_speed_down,4)*100 end ftp_speed_down_4
    </if>
    from 
    (
    select <include refid="samesql_tlog"/>
          avg(case when w.longitude_modify>0 then (case when (select s.configvalue from t_sysconfig s where s.configkey='t_map_type')='baidu' then w.longitude_bmap else w.longitude_modify end) else 0 end) lng_m,
          avg(case when w.latitude_modify>0 then (case when (select s.configvalue from t_sysconfig s where s.configkey='t_map_type')='baidu' then w.latitude_bmap else w.latitude_modify end) else 0 end) lat_m,
          avg(case when w.LATITUDE>0 then w.LATITUDE else 0 end) lat_y,
          avg(case when w.LONGITUDE>0 then w.LONGITUDE else 0 end) lng_y,
          case when min(t.net_type)=2 then '2' when min(t.net_type)=3 then '3' else '0' end net_type,
    min(t.ftp_avg_speed) ftp_avg_speed,
           <!--rscp  -->
           sum(case when w.rscp!=-9999 then 1 else 0 end) rscp,
           sum(case when w.rscp!=-9999 and (w.rscp! =-9998 and 
            <if test="rscp_s_4==1">
             w.rscp>#{rscp_v_4} 
           </if>
           <if test="rscp_s_4==2">
             w.rscp>=#{rscp_v_4} 
           </if>
           <if test="rscp_s_4==3">
             #{rscp_v_4}>w.rscp
           </if>
           <if test="rscp_s_4==4">
           #{rscp_v_4}>=w.rscp
           </if>

           ) then 1 else 0 end) rscp_1,
           
           sum(case when rscp!=-9999 and  w.rscp! =-9998 and 
             <if test="rscp_s_2==1">
             rscp>#{rscp_v_2} 
           </if>
           <if test="rscp_s_2==2">
             rscp>=#{rscp_v_2} 
           </if>
           <if test="rscp_s_2==3">
             #{rscp_v_2}>rscp
           </if>
           <if test="rscp_s_2==4">
           #{rscp_v_2}>=rscp
           </if>
    
           then 1 else 0 end) rscp_3,
           sum(case when w.rscp!=-9999 and  w.rscp! =-9998 and 
              <if test="rscp_s_1==1">
             w.rscp>#{rscp_v_1} 
           </if>
           <if test="rscp_s_1==2">
             w.rscp>=#{rscp_v_1} 
           </if>
           <if test="rscp_s_1==3">
             #{rscp_v_1}>w.rscp
           </if>
           <if test="rscp_s_1==4">
           #{rscp_v_1}>=w.rscp
           </if>
   
           then 1 else 0 end) rscp_4,
           
           <!-- ec_no -->
           sum(case when ec_no!=-9999 then 1 else 0 end) ec_no,
           sum(case when w.ec_no!=-9999 and (w.ec_no!=-9998 and 
           
             <if test="ecno_s_4==1">
             w.ec_no>#{ecno_v_4} 
           </if>
           <if test="ecno_s_4==2">
             w.ec_no>=#{ecno_v_4} 
           </if>
           <if test="ecno_s_4==3">
             #{ecno_v_4}>w.ec_no
           </if>
           <if test="ecno_s_4==4">
           #{ecno_v_4}>=w.ec_no
           </if>
           
           ) then 1 else 0 end) ec_no_1,
         
           sum(case when w.ec_no!=-9999 and w.ec_no!=-9998 and 
           <if test="ecno_s_2==1">
             w.ec_no>#{ecno_v_2} 
           </if>
           <if test="ecno_s_2==2">
             w.ec_no>=#{ecno_v_2} 
           </if>
           <if test="ecno_s_2==3">
             #{ecno_v_2}>w.ec_no
           </if>
           <if test="ecno_s_2==4">
           #{ecno_v_2}>=w.ec_no
           </if>
           
    
           then 1 else 0 end) ec_no_3,
           sum(case when w.ec_no!=-9999 and w.ec_no!=-9998 and 
           <if test="ecno_s_1==1">
             w.ec_no>#{ecno_v_1} 
           </if>
           <if test="ecno_s_1==2">
             w.ec_no>=#{ecno_v_1} 
           </if>
           <if test="ecno_s_1==3">
             #{ecno_v_1}>w.ec_no
           </if>
           <if test="ecno_s_1==4">
           #{ecno_v_1}>=w.ec_no
           </if>
       
           then 1 else 0 end) ec_no_4,
           
           <!-- txpower -->
           sum(case when w.txpower!=-9999 then 1 else 0 end) txpower,
           
           sum(case when w.txpower!=-9999 and w.txpower!=-9998 and 
           <if test="tx_s_1==1">
             w.txpower>#{tx_v_1} 
           </if>
           <if test="tx_s_1==2">
             w.txpower>=#{tx_v_1} 
           </if>
           <if test="tx_s_1==3">
             #{tx_v_1}>w.txpower
           </if>
           <if test="tx_s_1==4">
           #{tx_v_1}>=w.txpower
           </if>
           
            then 1 else 0 end) txpower_4,
           sum(case when w.txpower!=-9999 and w.txpower!=-9998 and
            <if test="tx_s_2==1">
             w.txpower>#{tx_v_2} 
           </if>
           <if test="tx_s_2==2">
             w.txpower>=#{tx_v_2} 
           </if>
           <if test="tx_s_2==3">
             #{tx_v_2}>w.txpower
           </if>
           <if test="tx_s_2==4">
           #{tx_v_2}>=w.txpower
           </if>
           
            then 1 else 0 end) txpower_3,
          
           sum(case when w.txpower!=-9999 and w.txpower!=-9998 and 
         <if test="tx_s_4==1">
             w.txpower>#{tx_v_4} 
           </if>
           <if test="tx_s_4==2">
             w.txpower>=#{tx_v_4} 
           </if>
           <if test="tx_s_4==3">
             #{tx_v_4}>w.txpower
           </if>
           <if test="tx_s_4==4">
           #{tx_v_4}>=w.txpower
           </if>
           then 1 else 0 end) txpower_1,
          
           <!-- FTP上行 -->
           sum(case when w.ftp_type=1 and w.ftp_speed!=-9999 then 1 else 0 end) ftp_speed_up,
           
           sum(case when w.ftp_type=1 and w.ftp_speed!=-9999 and (w.ftp_speed!=-9998 and (
            <if test="fu_s_1==1">
             w.ftp_speed>#{fu_v_1} 
           </if>
           <if test="fu_s_1==2">
             w.ftp_speed>=#{fu_v_1} 
           </if>
           <if test="fu_s_1==3">
             #{fu_v_1}>w.ftp_speed
           </if>
           <if test="fu_s_1==4">
           #{fu_v_1}>=w.ftp_speed
           </if>
           
       
           
           )
           
           ) then 1 else 0 end) ftp_speed_up_4,
           sum(case when w.ftp_type=1 and w.ftp_speed!=-9999 and w.ftp_speed!=-9998 and
              <if test="fu_s_2==1">
             w.ftp_speed>#{fu_v_2} 
           </if>
           <if test="fu_s_2==2">
             w.ftp_speed>=#{fu_v_2} 
           </if>
           <if test="fu_s_2==3">
             #{fu_v_2}>w.ftp_speed
           </if>
           <if test="fu_s_2==4">
           #{fu_v_2}>=w.ftp_speed
           </if>
           
           
           
           
           then 1 else 0 end) ftp_speed_up_3,
          
           sum(case when w.ftp_type=1 and w.ftp_speed!=-9999 and  w.ftp_speed!=-9998 and
           
            <if test="fu_s_4==1">
             w.ftp_speed>#{fu_v_2} 
           </if>
           <if test="fu_s_4==2">
             w.ftp_speed>=#{fu_v_4} 
           </if>
           <if test="fu_s_4==3">
             #{fu_v_4}>w.ftp_speed
           </if>
           <if test="fu_s_4==4">
           #{fu_v_4}>=w.ftp_speed
           </if>
           
        
           
           then 1 else 0 end) ftp_speed_up_1,
           <!-- FTP下行 -->
           sum(case when w.ftp_type=2 and w.ftp_speed!=-9999 then 1 else 0 end) ftp_speed_down,
           sum(case when w.ftp_type=2 and w.ftp_speed!=-9999 and (w.ftp_speed!=-9998 and  
           (
            <if test="fd_s_1==1">
             w.ftp_speed>#{fd_v_1} 
           </if>
           <if test="fd_s_1==2">
             w.ftp_speed>=#{fd_v_1} 
           </if>
           <if test="fd_s_1==3">
             #{fd_v_1}>w.ftp_speed
           </if>
           <if test="fd_s_1==4">
           #{fd_v_1}>=w.ftp_speed
           </if>
           
          
           
           )
           )  then 1 else 0 end) ftp_speed_down_4,
           sum(case when w.ftp_type=2 and w.ftp_speed!=-9999 and w.ftp_speed!=-9998 and
            <if test="fd_s_2==1">
             w.ftp_speed>#{fd_v_2} 
           </if>
           <if test="fd_s_2==2">
             w.ftp_speed>=#{fd_v_2} 
           </if>
           <if test="fd_s_2==3">
             #{fd_v_2}>w.ftp_speed
           </if>
           <if test="fd_s_2==4">
           #{fd_v_2}>=w.ftp_speed
           </if>
           
          
           
           
           then 1 else 0 end ) ftp_speed_down_3,
        
           sum(case when w.ftp_type=2 and w.ftp_speed!=-9999 and w.ftp_speed!=-9998 and
              <if test="fd_s_4==1">
             w.ftp_speed>#{fd_v_4} 
           </if>
           <if test="fd_s_4==2">
             w.ftp_speed>=#{fd_v_4} 
           </if>
           <if test="fd_s_4==3">
             #{fd_v_4}>w.ftp_speed
           </if>
           <if test="fd_s_4==4">
           #{fd_v_4}>=w.ftp_speed
           </if>
           
           
           then 1 else 0 end ) ftp_speed_down_1
          
    from t_log_submanual_wcdma w ,t_log_manual t where  w.flowid=t.flowid 
    <include refid="samesql_where_w"/>
    <!-- and w.ep_time >= to_date(#{startTime},'yyyy-mm-dd hh24:mi:ss')-1  and  to_date(#{endTime},'yyyy-mm-dd hh24:mi:ss')+1 >=w.ep_time -->
	<if test="kpi==1">
    and w.rscp&lt;>-9999
    </if>
    <if test="kpi==2">
    and w.ec_no&lt;>-9999
    </if>
    <if test="kpi==3">
    and w.txpower&lt;>-9999
    </if>
    <if test="kpi==4">
    and w.ftp_type=1
    and w.ftp_speed&lt;>-9999
    </if>
   	<if test="kpi==5">
    and w.ftp_type=2
    and w.ftp_speed&lt;>-9999
    </if>
    
     <!-- 指标查询 -->
    <if test="kpi==6 or kpi==7 or kpi==8">
     and  t.net_type=1
    </if>
     <!-- GSM时可选择自由模式 -->
    <if test="nettype==2">
     and t.net_type=1
    </if>
     <!-- 规避2G锁频有3G数据 -->
    
    and w.inside=0 
   and t.net_type in(2,3)
    <include refid="same_group"/>
    ) t,<include refid="btable_where"/> 
</sql>





<!-- 查询数据语句 -->
<select id="noqueryindoor2" resultType="com.complaint.model.GradeBean" parameterType="map">
<include refid="indoor2"/>
</select>
<select id="noqueryindoor3" resultType="com.complaint.model.GradeBean" parameterType="map">
<include refid="indoor3"/>
</select>
<select id="noqueryoutdoor2" resultType="com.complaint.model.GradeBean" parameterType="map">
<include refid="outdoor2"/>
</select>
<select id="noqueryoutdoor3" resultType="com.complaint.model.GradeBean" parameterType="map">
<include refid="outdoor3"/>
</select>
   <!-- 查询等级阈值 -->
<select id="showGradKpi" resultType="com.complaint.model.Rate" parameterType="map">
  select v.rank_arithmetic,v.rank_value,k.kpi_code,v.rank_code,v.rank_ratio,v.rank_avg ,k.scene
  from t_rate_value v,t_rate_kpi k where v.id=k.id 
</select>

<!-- 查询等级颜色 -->
<select id="showGradColor" resultType="com.complaint.model.RateColor">
  select  t.rank_color from t_rate_color t where t.scene=0 and t.type=1 order by t.rank_code asc
</select>

<!-- 查询项目分值-->
<select id="queryProject" resultType="com.complaint.model.EvaluateRule" parameterType="map">
 select * from t_evaluate_rule t 
 <if test="rankscore!=null and rankscore!=''">
 where t.rank_score=#{rankscore}
 </if>
 order by t.rank_code,t.rank_code_sub 
</select>
<!-- 查询指标分值-->
<select id="queryKpi" resultType="com.complaint.model.ScoreRule" >
 select * from t_score_rule t order by t.rank_code
</select>
<!-- 查询项目讲档数据 -->
<select id="queryProDrop" resultType="com.complaint.model.RevisRule">
select * from t_revis_rule t order by t.revis_type,id
</select>

<!-- 查询中心经纬度 -->
<select id="queryCenter" resultType="com.complaint.model.CenterZoom" parameterType="map">
 select 
 max(lat_m)max_lat,min(lat_m)min_lat,max(lng_m)max_lng,
 min(lng_m)min_lng from(
  <include refid="indoor2"/> union all 
  <include refid="indoor3"/> union all 
  <include refid="outdoor2"/> union all 
  <include refid="outdoor3"/> 
 )
</select>

<!-- 查询两点最远距离 -->
<select id="querydistence" resultType="com.complaint.model.CenterZoom" parameterType="map">
   select 
 trunc(2 * asin(sqrt(power(sin((#{maxlat}* 3.1415926 / 180.0 -  
         #{minlat} * 3.1415926 / 180.0) / 2),2) +cos(#{maxlat} * 3.1415926 / 180.0) *
         cos(#{minlat} * 3.1415926 / 180.0) *power(sin((#{maxlng} * 3.1415926 / 180.0 -
         #{minlng} * 3.1415926 / 180.0) / 2), 2))) * 6378137 ) as distance from dual
</select>
<!-- 查询点小区 -->
<select id="queryCells" resultType="com.complaint.model.TCasCell" parameterType="map"> 
select*from(
 select c.cid cellId, c.lac, c.LONGITUDE_MODIFY celllng,c.psc, c.cell_name,
	            c.LATITUDE_MODIFY celllat,b.base_name baseName,
 c.self_azimuth self_azimuth,
  c.ant_azimuth  ant_azimuth,c.mode_type modetype,
b.bid,max(c.indoor) indoor
  from t_log_submanual_wcdma w, t_log_manual t, t_cas_cell c,t_cas_base b
 where w.cid = c.cid
   and w.lac = c.lac
   and c.bid=b.bid
   and w.flowid = t.flowid
   and (t.net_type = 2 or t.net_type = 3)
   and c.LONGITUDE_MODIFY > 0
   and c.LATITUDE_MODIFY > 0
   and w.flowid = #{flowid}
 group by c.cid, c.lac,  c.LONGITUDE_MODIFY ,c.psc,c.cell_name,
	            c.LATITUDE_MODIFY ,c.mode_type,b.base_name,
  c.self_azimuth ,
  c.ant_azimuth  
,b.bid
union all
select c.cid cellId, c.lac,  c.LONGITUDE_MODIFY celllng,c.psc, c.cell_name,
	            c.LATITUDE_MODIFY celllat,b.base_name baseName,
 c.self_azimuth self_azimuth,c.mode_type modetype,
  c.ant_azimuth  ant_azimuth,b.bid,max(c.indoor) indoor
  from t_log_submanual_gsm g, t_log_manual t, t_cas_cell c,t_cas_base b
 where g.cid = c.cid
   and g.lac = c.lac
   and c.bid=b.bid
   and g.flowid = t.flowid
   and (t.net_type = 1 or t.net_type = 3)
   and c.LONGITUDE_MODIFY > 0
   and c.LATITUDE_MODIFY > 0
   and g.flowid =#{flowid}
 group by c.cid, c.lac,  c.LONGITUDE_MODIFY ,c.psc,c.cell_name,
	            c.LATITUDE_MODIFY ,b.base_name,c.mode_type ,
 c.self_azimuth ,
  c.ant_azimuth  
 ,b.bid) order by cell_name
</select>
</mapper>